apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: awsinfra-iam
spec:
  compositeTypeRef:
    apiVersion: aws.kfo.io/v1alpha1
    kind: awsinfra
  mode: Pipeline
  pipeline:

  - step: role-creation
    functionRef:
      name: crossplane-contrib-function-patch-and-transform
    input:
      apiVersion: pt.fn.crossplane.io/v1beta1
      kind: Resources
      resources:
      - name: karpenter-node-role
        base:
          apiVersion: iam.aws.m.upbound.io/v1beta1
          kind: Role
          metadata:
            annotations:
              meta.upbound.io/example-id: iam/v1beta1/rolepolicy
          spec:
            forProvider:
              assumeRolePolicy: |
                {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "ec2.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                }
        patches:
          - type: CombineFromComposite
            combine:
              variables:
                - fromFieldPath: spec.cluster_name
              strategy: string
              string:
                fmt: "karpenter-node-role-%s"
            toFieldPath: metadata.name
          - type: FromCompositeFieldPath
            fromFieldPath: spec.upbound_namespace
            toFieldPath: metadata.namespace


  - step: role-policy-attachments
    functionRef:
      name: crossplane-contrib-function-patch-and-transform
    input:
      apiVersion: pt.fn.crossplane.io/v1beta1
      kind: Resources
      resources:

      - name: karpenter-node-role-attachment-AmazonEKSWorkerNodePolicy
        base:
          apiVersion: iam.aws.m.upbound.io/v1beta1
          kind: RolePolicyAttachment
          metadata:
            annotations:
              meta.upbound.io/example-id: iam/v1beta1/role
            name: karpenter-node-role-attachments
          spec:
            forProvider:
              policyArn: arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy
              roleRef:
                name: karpenter-node-role-placeholder
                namespace: crossplane-system-placeholder
            providerConfigRef:
              kind: ClusterProviderConfig
              name: default
        patches:
          - type: CombineFromComposite
            combine:
              variables:
                - fromFieldPath: spec.cluster_name
              strategy: string
              string:
                fmt: "karpenter-node-role-%s"
            toFieldPath: spec.forProvider.roleRef.name  
          - type: FromCompositeFieldPath
            fromFieldPath: spec.upbound_namespace
            toFieldPath: metadata.namespace
          - type: FromCompositeFieldPath
            fromFieldPath: spec.upbound_namespace
            toFieldPath: spec.forProvider.roleRef.namespace

      - name: karpenter-node-role-attachments-AmazonEKS_CNI_Policy
        base:
          apiVersion: iam.aws.m.upbound.io/v1beta1
          kind: RolePolicyAttachment
          metadata:
            annotations:
              meta.upbound.io/example-id: iam/v1beta1/role
            name: karpenter-node-role-attachments
          spec:
            forProvider:
              policyArn: arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy
              roleRef:
                name: karpenter-node-role-placeholder
                namespace: crossplane-system-placeholder
            providerConfigRef:
              kind: ClusterProviderConfig
              name: default
        patches:
          - type: CombineFromComposite
            combine:
              variables:
                - fromFieldPath: spec.cluster_name
              strategy: string
              string:
                fmt: "karpenter-node-role-%s"
            toFieldPath: spec.forProvider.roleRef.name  
          - type: FromCompositeFieldPath
            fromFieldPath: spec.upbound_namespace
            toFieldPath: metadata.namespace
          - type: FromCompositeFieldPath
            fromFieldPath: spec.upbound_namespace
            toFieldPath: spec.forProvider.roleRef.namespace

      - name: karpenter-node-role-attachment-AmazonSSMManagedInstanceCore
        base:
          apiVersion: iam.aws.m.upbound.io/v1beta1
          kind: RolePolicyAttachment
          metadata:
            annotations:
              meta.upbound.io/example-id: iam/v1beta1/role
            name: karpenter-node-role-attachments
          spec:
            forProvider:
              policyArn: arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryPullOnly
              roleRef:
                name: karpenter-node-role-placeholder
                namespace: crossplane-system-placeholder
            providerConfigRef:
              kind: ClusterProviderConfig
              name: default
        patches:
          - type: CombineFromComposite
            combine:
              variables:
                - fromFieldPath: spec.cluster_name
              strategy: string
              string:
                fmt: "karpenter-node-role-%s"
            toFieldPath: spec.forProvider.roleRef.name  
          - type: FromCompositeFieldPath
            fromFieldPath: spec.upbound_namespace
            toFieldPath: metadata.namespace
          - type: FromCompositeFieldPath
            fromFieldPath: spec.upbound_namespace
            toFieldPath: spec.forProvider.roleRef.namespace

      - name: karpenter-node-role-attachment-AmazonEC2ContainerRegistryPullOnly
        base:
          apiVersion: iam.aws.m.upbound.io/v1beta1
          kind: RolePolicyAttachment
          metadata:
            annotations:
              meta.upbound.io/example-id: iam/v1beta1/role
            name: karpenter-node-role-attachments
          spec:
            forProvider:
              policyArn: arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
              roleRef:
                name: karpenter-node-role-placeholder
                namespace: crossplane-system-placeholder
            providerConfigRef:
              kind: ClusterProviderConfig
              name: default
        patches:
          - type: CombineFromComposite
            combine:
              variables:
                - fromFieldPath: spec.cluster_name
              strategy: string
              string:
                fmt: "karpenter-node-role-%s"
            toFieldPath: spec.forProvider.roleRef.name  
          - type: FromCompositeFieldPath
            fromFieldPath: spec.upbound_namespace
            toFieldPath: metadata.namespace
          - type: FromCompositeFieldPath
            fromFieldPath: spec.upbound_namespace
            toFieldPath: spec.forProvider.roleRef.namespace
            

  - step: karpenter-controller-role
    functionRef:
      name: crossplane-contrib-function-patch-and-transform
    input:
      apiVersion: pt.fn.crossplane.io/v1beta1
      kind: Resources
      resources:
      # - name: karpenter-controller-policy
      #   base:
      #     apiVersion: iam.aws.m.upbound.io/v1beta1
      #     kind: Policy 
      #     metadata:
      #       annotations:
      #         meta.upbound.io/example-id: iam/v1beta1/policy

      #       name: karpenter-controller-policy-placeholder
      #       namespace: upbound-system-placeholder
      #     spec:
      #       forProvider:
      #         policy: | #TODO: modify the policy template replace the values whit patch and transform function
      #           {
      #             "Version": "2012-10-17",
      #             "Statement": [
      #               {
      #                 "Sid": "AllowScopedEC2InstanceAccessActions",
      #                 "Effect": "Allow",
      #                 "Resource": [
      #                   "arn:${AWS::Partition}:ec2:${AWS::Region}::image/*",
      #                   "arn:${AWS::Partition}:ec2:${AWS::Region}::snapshot/*",
      #                   "arn:${AWS::Partition}:ec2:${AWS::Region}:*:security-group/*",
      #                   "arn:${AWS::Partition}:ec2:${AWS::Region}:*:subnet/*",
      #                   "arn:${AWS::Partition}:ec2:${AWS::Region}:*:capacity-reservation/*"
      #                 ],
      #                 "Action": [
      #                   "ec2:RunInstances",
      #                   "ec2:CreateFleet"
      #                 ]
      #               },
      #               {
      #                 "Sid": "AllowScopedEC2LaunchTemplateAccessActions",
      #                 "Effect": "Allow",
      #                 "Resource": "arn:${AWS::Partition}:ec2:${AWS::Region}:*:launch-template/*",
      #                 "Action": [
      #                   "ec2:RunInstances",
      #                   "ec2:CreateFleet"
      #                 ],
      #                 "Condition": {
      #                   "StringEquals": {
      #                     "aws:ResourceTag/kubernetes.io/cluster/${ClusterName}": "owned"
      #                   },
      #                   "StringLike": {
      #                     "aws:ResourceTag/karpenter.sh/nodepool": "*"
      #                   }
      #                 }
      #               },
      #               {
      #                 "Sid": "AllowScopedEC2InstanceActionsWithTags",
      #                 "Effect": "Allow",
      #                 "Resource": [
      #                   "arn:${AWS::Partition}:ec2:${AWS::Region}:*:fleet/*",
      #                   "arn:${AWS::Partition}:ec2:${AWS::Region}:*:instance/*",
      #                   "arn:${AWS::Partition}:ec2:${AWS::Region}:*:volume/*",
      #                   "arn:${AWS::Partition}:ec2:${AWS::Region}:*:network-interface/*",
      #                   "arn:${AWS::Partition}:ec2:${AWS::Region}:*:launch-template/*",
      #                   "arn:${AWS::Partition}:ec2:${AWS::Region}:*:spot-instances-request/*",
      #                   "arn:${AWS::Partition}:ec2:${AWS::Region}:*:capacity-reservation/*"
      #                 ],
      #                 "Action": [
      #                   "ec2:RunInstances",
      #                   "ec2:CreateFleet",
      #                   "ec2:CreateLaunchTemplate"
      #                 ],
      #                 "Condition": {
      #                   "StringEquals": {
      #                     "aws:RequestTag/kubernetes.io/cluster/${ClusterName}": "owned",
      #                     "aws:RequestTag/eks:eks-cluster-name": "${ClusterName}"
      #                   },
      #                   "StringLike": {
      #                     "aws:RequestTag/karpenter.sh/nodepool": "*"
      #                   }
      #                 }
      #               },
      #               {
      #                 "Sid": "AllowScopedResourceCreationTagging",
      #                 "Effect": "Allow",
      #                 "Resource": [
      #                   "arn:${AWS::Partition}:ec2:${AWS::Region}:*:fleet/*",
      #                   "arn:${AWS::Partition}:ec2:${AWS::Region}:*:instance/*",
      #                   "arn:${AWS::Partition}:ec2:${AWS::Region}:*:volume/*",
      #                   "arn:${AWS::Partition}:ec2:${AWS::Region}:*:network-interface/*",
      #                   "arn:${AWS::Partition}:ec2:${AWS::Region}:*:launch-template/*",
      #                   "arn:${AWS::Partition}:ec2:${AWS::Region}:*:spot-instances-request/*"
      #                 ],
      #                 "Action": "ec2:CreateTags",
      #                 "Condition": {
      #                   "StringEquals": {
      #                     "aws:RequestTag/kubernetes.io/cluster/${ClusterName}": "owned",
      #                     "aws:RequestTag/eks:eks-cluster-name": "${ClusterName}",
      #                     "ec2:CreateAction": [
      #                       "RunInstances",
      #                       "CreateFleet",
      #                       "CreateLaunchTemplate"
      #                     ]
      #                   },
      #                   "StringLike": {
      #                     "aws:RequestTag/karpenter.sh/nodepool": "*"
      #                   }
      #                 }
      #               },
      #               {
      #                 "Sid": "AllowScopedResourceTagging",
      #                 "Effect": "Allow",
      #                 "Resource": "arn:${AWS::Partition}:ec2:${AWS::Region}:*:instance/*",
      #                 "Action": "ec2:CreateTags",
      #                 "Condition": {
      #                   "StringEquals": {
      #                     "aws:ResourceTag/kubernetes.io/cluster/${ClusterName}": "owned"
      #                   },
      #                   "StringLike": {
      #                     "aws:ResourceTag/karpenter.sh/nodepool": "*"
      #                   },
      #                   "StringEqualsIfExists": {
      #                     "aws:RequestTag/eks:eks-cluster-name": "${ClusterName}"
      #                   },
      #                   "ForAllValues:StringEquals": {
      #                     "aws:TagKeys": [
      #                       "eks:eks-cluster-name",
      #                       "karpenter.sh/nodeclaim",
      #                       "Name"
      #                     ]
      #                   }
      #                 }
      #               },
      #               {
      #                 "Sid": "AllowScopedDeletion",
      #                 "Effect": "Allow",
      #                 "Resource": [
      #                   "arn:${AWS::Partition}:ec2:${AWS::Region}:*:instance/*",
      #                   "arn:${AWS::Partition}:ec2:${AWS::Region}:*:launch-template/*"
      #                 ],
      #                 "Action": [
      #                   "ec2:TerminateInstances",
      #                   "ec2:DeleteLaunchTemplate"
      #                 ],
      #                 "Condition": {
      #                   "StringEquals": {
      #                     "aws:ResourceTag/kubernetes.io/cluster/${ClusterName}": "owned"
      #                   },
      #                   "StringLike": {
      #                     "aws:ResourceTag/karpenter.sh/nodepool": "*"
      #                   }
      #                 }
      #               },
      #               {
      #                 "Sid": "AllowRegionalReadActions",
      #                 "Effect": "Allow",
      #                 "Resource": "*",
      #                 "Action": [
      #                   "ec2:DescribeCapacityReservations",
      #                   "ec2:DescribeImages",
      #                   "ec2:DescribeInstances",
      #                   "ec2:DescribeInstanceTypeOfferings",
      #                   "ec2:DescribeInstanceTypes",
      #                   "ec2:DescribeLaunchTemplates",
      #                   "ec2:DescribeSecurityGroups",
      #                   "ec2:DescribeSpotPriceHistory",
      #                   "ec2:DescribeSubnets"
      #                 ],
      #                 "Condition": {
      #                   "StringEquals": {
      #                     "aws:RequestedRegion": "${AWS::Region}"
      #                   }
      #                 }
      #               },
      #               {
      #                 "Sid": "AllowSSMReadActions",
      #                 "Effect": "Allow",
      #                 "Resource": "arn:${AWS::Partition}:ssm:${AWS::Region}::parameter/aws/service/*",
      #                 "Action": "ssm:GetParameter"
      #               },
      #               {
      #                 "Sid": "AllowPricingReadActions",
      #                 "Effect": "Allow",
      #                 "Resource": "*",
      #                 "Action": "pricing:GetProducts"
      #               },
      #               {
      #                 "Sid": "AllowInterruptionQueueActions",
      #                 "Effect": "Allow",
      #                 "Resource": "${KarpenterInterruptionQueue.Arn}",
      #                 "Action": [
      #                   "sqs:DeleteMessage",
      #                   "sqs:GetQueueUrl",
      #                   "sqs:ReceiveMessage"
      #                 ]
      #               },
      #               {
      #                 "Sid": "AllowPassingInstanceRole",
      #                 "Effect": "Allow",
      #                 "Resource": "${KarpenterNodeRole.Arn}",
      #                 "Action": "iam:PassRole",
      #                 "Condition": {
      #                   "StringEquals": {
      #                     "iam:PassedToService": [
      #                       "ec2.amazonaws.com",
      #                       "ec2.amazonaws.com.cn"
      #                     ]
      #                   }
      #                 }
      #               },
      #               {
      #                 "Sid": "AllowScopedInstanceProfileCreationActions",
      #                 "Effect": "Allow",
      #                 "Resource": "arn:${AWS::Partition}:iam::${AWS::AccountId}:instance-profile/*",
      #                 "Action": [
      #                   "iam:CreateInstanceProfile"
      #                 ],
      #                 "Condition": {
      #                   "StringEquals": {
      #                     "aws:RequestTag/kubernetes.io/cluster/${ClusterName}": "owned",
      #                     "aws:RequestTag/eks:eks-cluster-name": "${ClusterName}",
      #                     "aws:RequestTag/topology.kubernetes.io/region": "${AWS::Region}"
      #                   },
      #                   "StringLike": {
      #                     "aws:RequestTag/karpenter.k8s.aws/ec2nodeclass": "*"
      #                   }
      #                 }
      #               },
      #               {
      #                 "Sid": "AllowScopedInstanceProfileTagActions",
      #                 "Effect": "Allow",
      #                 "Resource": "arn:${AWS::Partition}:iam::${AWS::AccountId}:instance-profile/*",
      #                 "Action": [
      #                   "iam:TagInstanceProfile"
      #                 ],
      #                 "Condition": {
      #                   "StringEquals": {
      #                     "aws:ResourceTag/kubernetes.io/cluster/${ClusterName}": "owned",
      #                     "aws:ResourceTag/topology.kubernetes.io/region": "${AWS::Region}",
      #                     "aws:RequestTag/kubernetes.io/cluster/${ClusterName}": "owned",
      #                     "aws:RequestTag/eks:eks-cluster-name": "${ClusterName}",
      #                     "aws:RequestTag/topology.kubernetes.io/region": "${AWS::Region}"
      #                   },
      #                   "StringLike": {
      #                     "aws:ResourceTag/karpenter.k8s.aws/ec2nodeclass": "*",
      #                     "aws:RequestTag/karpenter.k8s.aws/ec2nodeclass": "*"
      #                   }
      #                 }
      #               },
      #               {
      #                 "Sid": "AllowScopedInstanceProfileActions",
      #                 "Effect": "Allow",
      #                 "Resource": "arn:${AWS::Partition}:iam::${AWS::AccountId}:instance-profile/*",
      #                 "Action": [
      #                   "iam:AddRoleToInstanceProfile",
      #                   "iam:RemoveRoleFromInstanceProfile",
      #                   "iam:DeleteInstanceProfile"
      #                 ],
      #                 "Condition": {
      #                   "StringEquals": {
      #                     "aws:ResourceTag/kubernetes.io/cluster/${ClusterName}": "owned",
      #                     "aws:ResourceTag/topology.kubernetes.io/region": "${AWS::Region}"
      #                   },
      #                   "StringLike": {
      #                     "aws:ResourceTag/karpenter.k8s.aws/ec2nodeclass": "*"
      #                   }
      #                 }
      #               },
      #               {
      #                 "Sid": "AllowInstanceProfileReadActions",
      #                 "Effect": "Allow",
      #                 "Resource": "arn:${AWS::Partition}:iam::${AWS::AccountId}:instance-profile/*",
      #                 "Action": "iam:GetInstanceProfile"
      #               },
      #               {
      #                 "Sid": "AllowUnscopedInstanceProfileListAction",
      #                 "Effect": "Allow",
      #                 "Resource": "*",
      #                 "Action": "iam:ListInstanceProfiles"
      #               },
      #               {
      #                 "Sid": "AllowAPIServerEndpointDiscovery",
      #                 "Effect": "Allow",
      #                 "Resource": "arn:${AWS::Partition}:eks:${AWS::Region}:${AWS::AccountId}:cluster/${ClusterName}",
      #                 "Action": "eks:DescribeCluster"
      #               }
      #             ]
      #           }

      #   patches:
      #     - type: CombineFromComposite
      #       combine:
      #         variables:
      #           - fromFieldPath: spec.cluster_name
      #         strategy: string
      #         string:
      #           fmt: "karpenter-controller-policy-%s"
      #       toFieldPath: metadata.name
      #     - type: FromCompositeFieldPath
      #       fromFieldPath: spec.upbound_namespace
      #       toFieldPath: metadata.namespace

      - name: karpenter-controller-role
        base:
          apiVersion: iam.aws.m.upbound.io/v1beta1
          kind: Role
          metadata:
            name: karpenter-controller-role-placeholder
            namespace: upbound-system-placeholder
          spec:
            forProvider:
              inlinePolicy:
                - name: karpenter-controller-policy
                  policy: | #TODO: modify the policy template replace the values whit patch and transform function
                    {
                      "Version": "2012-10-17",
                      "Statement": [
                        {
                          "Sid": "AllowScopedEC2InstanceAccessActions",
                          "Effect": "Allow",
                          "Resource": [
                            "arn:${AWS::Partition}:ec2:${AWS::Region}::image/*",
                            "arn:${AWS::Partition}:ec2:${AWS::Region}::snapshot/*",
                            "arn:${AWS::Partition}:ec2:${AWS::Region}:*:security-group/*",
                            "arn:${AWS::Partition}:ec2:${AWS::Region}:*:subnet/*",
                            "arn:${AWS::Partition}:ec2:${AWS::Region}:*:capacity-reservation/*"
                          ],
                          "Action": [
                            "ec2:RunInstances",
                            "ec2:CreateFleet"
                          ]
                        },
                        {
                          "Sid": "AllowScopedEC2LaunchTemplateAccessActions",
                          "Effect": "Allow",
                          "Resource": "arn:${AWS::Partition}:ec2:${AWS::Region}:*:launch-template/*",
                          "Action": [
                            "ec2:RunInstances",
                            "ec2:CreateFleet"
                          ],
                          "Condition": {
                            "StringEquals": {
                              "aws:ResourceTag/kubernetes.io/cluster/${ClusterName}": "owned"
                            },
                            "StringLike": {
                              "aws:ResourceTag/karpenter.sh/nodepool": "*"
                            }
                          }
                        },
                        {
                          "Sid": "AllowScopedEC2InstanceActionsWithTags",
                          "Effect": "Allow",
                          "Resource": [
                            "arn:${AWS::Partition}:ec2:${AWS::Region}:*:fleet/*",
                            "arn:${AWS::Partition}:ec2:${AWS::Region}:*:instance/*",
                            "arn:${AWS::Partition}:ec2:${AWS::Region}:*:volume/*",
                            "arn:${AWS::Partition}:ec2:${AWS::Region}:*:network-interface/*",
                            "arn:${AWS::Partition}:ec2:${AWS::Region}:*:launch-template/*",
                            "arn:${AWS::Partition}:ec2:${AWS::Region}:*:spot-instances-request/*",
                            "arn:${AWS::Partition}:ec2:${AWS::Region}:*:capacity-reservation/*"
                          ],
                          "Action": [
                            "ec2:RunInstances",
                            "ec2:CreateFleet",
                            "ec2:CreateLaunchTemplate"
                          ],
                          "Condition": {
                            "StringEquals": {
                              "aws:RequestTag/kubernetes.io/cluster/${ClusterName}": "owned",
                              "aws:RequestTag/eks:eks-cluster-name": "${ClusterName}"
                            },
                            "StringLike": {
                              "aws:RequestTag/karpenter.sh/nodepool": "*"
                            }
                          }
                        },
                        {
                          "Sid": "AllowScopedResourceCreationTagging",
                          "Effect": "Allow",
                          "Resource": [
                            "arn:${AWS::Partition}:ec2:${AWS::Region}:*:fleet/*",
                            "arn:${AWS::Partition}:ec2:${AWS::Region}:*:instance/*",
                            "arn:${AWS::Partition}:ec2:${AWS::Region}:*:volume/*",
                            "arn:${AWS::Partition}:ec2:${AWS::Region}:*:network-interface/*",
                            "arn:${AWS::Partition}:ec2:${AWS::Region}:*:launch-template/*",
                            "arn:${AWS::Partition}:ec2:${AWS::Region}:*:spot-instances-request/*"
                          ],
                          "Action": "ec2:CreateTags",
                          "Condition": {
                            "StringEquals": {
                              "aws:RequestTag/kubernetes.io/cluster/${ClusterName}": "owned",
                              "aws:RequestTag/eks:eks-cluster-name": "${ClusterName}",
                              "ec2:CreateAction": [
                                "RunInstances",
                                "CreateFleet",
                                "CreateLaunchTemplate"
                              ]
                            },
                            "StringLike": {
                              "aws:RequestTag/karpenter.sh/nodepool": "*"
                            }
                          }
                        },
                        {
                          "Sid": "AllowScopedResourceTagging",
                          "Effect": "Allow",
                          "Resource": "arn:${AWS::Partition}:ec2:${AWS::Region}:*:instance/*",
                          "Action": "ec2:CreateTags",
                          "Condition": {
                            "StringEquals": {
                              "aws:ResourceTag/kubernetes.io/cluster/${ClusterName}": "owned"
                            },
                            "StringLike": {
                              "aws:ResourceTag/karpenter.sh/nodepool": "*"
                            },
                            "StringEqualsIfExists": {
                              "aws:RequestTag/eks:eks-cluster-name": "${ClusterName}"
                            },
                            "ForAllValues:StringEquals": {
                              "aws:TagKeys": [
                                "eks:eks-cluster-name",
                                "karpenter.sh/nodeclaim",
                                "Name"
                              ]
                            }
                          }
                        },
                        {
                          "Sid": "AllowScopedDeletion",
                          "Effect": "Allow",
                          "Resource": [
                            "arn:${AWS::Partition}:ec2:${AWS::Region}:*:instance/*",
                            "arn:${AWS::Partition}:ec2:${AWS::Region}:*:launch-template/*"
                          ],
                          "Action": [
                            "ec2:TerminateInstances",
                            "ec2:DeleteLaunchTemplate"
                          ],
                          "Condition": {
                            "StringEquals": {
                              "aws:ResourceTag/kubernetes.io/cluster/${ClusterName}": "owned"
                            },
                            "StringLike": {
                              "aws:ResourceTag/karpenter.sh/nodepool": "*"
                            }
                          }
                        },
                        {
                          "Sid": "AllowRegionalReadActions",
                          "Effect": "Allow",
                          "Resource": "*",
                          "Action": [
                            "ec2:DescribeCapacityReservations",
                            "ec2:DescribeImages",
                            "ec2:DescribeInstances",
                            "ec2:DescribeInstanceTypeOfferings",
                            "ec2:DescribeInstanceTypes",
                            "ec2:DescribeLaunchTemplates",
                            "ec2:DescribeSecurityGroups",
                            "ec2:DescribeSpotPriceHistory",
                            "ec2:DescribeSubnets"
                          ],
                          "Condition": {
                            "StringEquals": {
                              "aws:RequestedRegion": "${AWS::Region}"
                            }
                          }
                        },
                        {
                          "Sid": "AllowSSMReadActions",
                          "Effect": "Allow",
                          "Resource": "arn:${AWS::Partition}:ssm:${AWS::Region}::parameter/aws/service/*",
                          "Action": "ssm:GetParameter"
                        },
                        {
                          "Sid": "AllowPricingReadActions",
                          "Effect": "Allow",
                          "Resource": "*",
                          "Action": "pricing:GetProducts"
                        },
                        {
                          "Sid": "AllowInterruptionQueueActions",
                          "Effect": "Allow",
                          "Resource": "${KarpenterInterruptionQueue.Arn}",
                          "Action": [
                            "sqs:DeleteMessage",
                            "sqs:GetQueueUrl",
                            "sqs:ReceiveMessage"
                          ]
                        },
                        {
                          "Sid": "AllowPassingInstanceRole",
                          "Effect": "Allow",
                          "Resource": "${KarpenterNodeRole.Arn}",
                          "Action": "iam:PassRole",
                          "Condition": {
                            "StringEquals": {
                              "iam:PassedToService": [
                                "ec2.amazonaws.com",
                                "ec2.amazonaws.com.cn"
                              ]
                            }
                          }
                        },
                        {
                          "Sid": "AllowScopedInstanceProfileCreationActions",
                          "Effect": "Allow",
                          "Resource": "arn:${AWS::Partition}:iam::${AWS::AccountId}:instance-profile/*",
                          "Action": [
                            "iam:CreateInstanceProfile"
                          ],
                          "Condition": {
                            "StringEquals": {
                              "aws:RequestTag/kubernetes.io/cluster/${ClusterName}": "owned",
                              "aws:RequestTag/eks:eks-cluster-name": "${ClusterName}",
                              "aws:RequestTag/topology.kubernetes.io/region": "${AWS::Region}"
                            },
                            "StringLike": {
                              "aws:RequestTag/karpenter.k8s.aws/ec2nodeclass": "*"
                            }
                          }
                        },
                        {
                          "Sid": "AllowScopedInstanceProfileTagActions",
                          "Effect": "Allow",
                          "Resource": "arn:${AWS::Partition}:iam::${AWS::AccountId}:instance-profile/*",
                          "Action": [
                            "iam:TagInstanceProfile"
                          ],
                          "Condition": {
                            "StringEquals": {
                              "aws:ResourceTag/kubernetes.io/cluster/${ClusterName}": "owned",
                              "aws:ResourceTag/topology.kubernetes.io/region": "${AWS::Region}",
                              "aws:RequestTag/kubernetes.io/cluster/${ClusterName}": "owned",
                              "aws:RequestTag/eks:eks-cluster-name": "${ClusterName}",
                              "aws:RequestTag/topology.kubernetes.io/region": "${AWS::Region}"
                            },
                            "StringLike": {
                              "aws:ResourceTag/karpenter.k8s.aws/ec2nodeclass": "*",
                              "aws:RequestTag/karpenter.k8s.aws/ec2nodeclass": "*"
                            }
                          }
                        },
                        {
                          "Sid": "AllowScopedInstanceProfileActions",
                          "Effect": "Allow",
                          "Resource": "arn:${AWS::Partition}:iam::${AWS::AccountId}:instance-profile/*",
                          "Action": [
                            "iam:AddRoleToInstanceProfile",
                            "iam:RemoveRoleFromInstanceProfile",
                            "iam:DeleteInstanceProfile"
                          ],
                          "Condition": {
                            "StringEquals": {
                              "aws:ResourceTag/kubernetes.io/cluster/${ClusterName}": "owned",
                              "aws:ResourceTag/topology.kubernetes.io/region": "${AWS::Region}"
                            },
                            "StringLike": {
                              "aws:ResourceTag/karpenter.k8s.aws/ec2nodeclass": "*"
                            }
                          }
                        },
                        {
                          "Sid": "AllowInstanceProfileReadActions",
                          "Effect": "Allow",
                          "Resource": "arn:${AWS::Partition}:iam::${AWS::AccountId}:instance-profile/*",
                          "Action": "iam:GetInstanceProfile"
                        },
                        {
                          "Sid": "AllowUnscopedInstanceProfileListAction",
                          "Effect": "Allow",
                          "Resource": "*",
                          "Action": "iam:ListInstanceProfiles"
                        },
                        {
                          "Sid": "AllowAPIServerEndpointDiscovery",
                          "Effect": "Allow",
                          "Resource": "arn:${AWS::Partition}:eks:${AWS::Region}:${AWS::AccountId}:cluster/${ClusterName}",
                          "Action": "eks:DescribeCluster"
                        }
                      ]
                    }
        patches:
          - type: CombineFromComposite
            combine:
              variables:
                - fromFieldPath: spec.cluster_name
              strategy: string
              string:
                fmt: "%s-karpenter-controller-role"
            toFieldPath: metadata.name
          - type: CombineFromComposite
            combine:
              variables:
                - fromFieldPath: spec.cluster_name
              strategy: string
              string:
                fmt: "karpenter-controller-policy-%s"
            toFieldPath: spec.forProvider.inlinePolicy[0].name
          - type: FromCompositeFieldPath
            fromFieldPath: spec.upbound_namespace
            toFieldPath: metadata.namespace