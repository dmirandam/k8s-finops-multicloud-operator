# -------------------- Namespace y propagación --------------------
apiVersion: v1
kind: Namespace
metadata:
  name: demo
---
apiVersion: policy.karmada.io/v1alpha1
kind: ClusterPropagationPolicy
metadata:
  name: ns-demo
spec:
  resourceSelectors:
  - apiVersion: v1
    kind: Namespace
    name: demo
  placement:
    clusterAffinity:
      clusterNames:
      - microk8s-cluster-1
      - microk8s-cluster-2

# -------------------- Deployment --------------------
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: web
  namespace: demo
spec:
  replicas: 10   # número base, se sobrescribe con OverridePolicy
  selector:
    matchLabels:
      app: web
  template:
    metadata:
      labels:
        app: web
    spec:
      containers:
      - name: nginx
        image: nginx:1.27
        ports:
        - containerPort: 80

# -------------------- Propagación de recursos namespaced --------------------
---
apiVersion: policy.karmada.io/v1alpha1
kind: PropagationPolicy
metadata:
  name: demo-prop
  namespace: demo
spec:
  resourceSelectors:
  - apiVersion: apps/v1
    kind: Deployment
    name: web
  - apiVersion: v1
    kind: Service
    name: web
  placement:
    clusterAffinity:
      clusterNames:
      - microk8s-cluster-1
      - microk8s-cluster-2

# -------------------- OverridePolicy para controlar réplicas --------------------
---
apiVersion: policy.karmada.io/v1alpha1
kind: OverridePolicy
metadata:
  name: web-replicas-override
  namespace: demo
spec:
  resourceSelectors:
  - apiVersion: apps/v1
    kind: Deployment
    name: web
  overrideRules:
  - targetCluster:
      clusterNames: ["microk8s-cluster-1"]
    overriders:
      plaintext:
      - path: "/spec/replicas"
        operator: replace
        value: 3
  - targetCluster:
      clusterNames: ["microk8s-cluster-2"]
    overriders:
      plaintext:
      - path: "/spec/replicas"
        operator: replace
        value: 7

# -------------------- NodePort Service --------------------
---
apiVersion: v1
kind: Service
metadata:
  name: web
  namespace: demo
spec:
  selector:
    app: web
  type: NodePort
  ports:
  - port: 80           
    targetPort: 80     
    nodePort: 30080    
